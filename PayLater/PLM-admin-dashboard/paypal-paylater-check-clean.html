<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PayPal PayLater Message Check - Clean Sample</title>
    </head>
    <body>
        <div
            id="test-containers"
            style="
                position: absolute;
                visibility: hidden;
                width: 1px;
                height: 1px;
                overflow: hidden;
            "
        ></div>

        <script src="https://www.paypal.com/sdk/js?client-id=AZzRp3LalDO6KnI67OauLv0eFHjBq0TQJ7VpQK4M60B05SsPf-WB_nbh4DJraygQzf3B4ZLJGA2Uv0aZ&components=messages"></script>

        <script>
            const countryList = [
                "US",
                "GB",
                "DE",
                "FR",
                "IT",
                "ES",
                "AU",
                "CA",
            ];

            /**
             * 检测单个国家的 PayLater Message 是否能渲染
             * @param {string} country
             */
            function checkCountry(country) {
                return new Promise((resolve) => {
                    // 1. 动态创建一个容器
                    const containerId = `pp-msg-${country}`;
                    const div = document.createElement("div");
                    div.id = containerId;
                    document.getElementById("test-containers").appendChild(div);

                    let isResolved = false;

                    // 3. 调用 SDK 渲染
                    try {
                        if (!window.paypal || !window.paypal.Messages) {
                            throw new Error("SDK not ready");
                        }

                        paypal
                            .Messages({
                                buyerCountry: country,
                                placement: "product",

                                // 成功回调
                                onRender: function () {
                                    if (!isResolved) {
                                        isResolved = true;
                                        resolve({
                                            country,
                                            success: true,
                                            reason: "Rendered",
                                        });
                                    }
                                },
                            })
                            .render(`#${containerId}`)
                            .catch((err) => {
                                // SDK 明确报错
                                if (!isResolved) {
                                    isResolved = true;
                                    resolve({
                                        country,
                                        success: false,
                                        reason: err.message || "Render Error",
                                    });
                                }
                            });
                    } catch (e) {
                        // 代码执行错误
                        if (!isResolved) {
                            isResolved = true;
                            resolve({
                                country,
                                success: false,
                                reason: e.message || "Script Error",
                            });
                        }
                    }
                });
            }

            // 主执行逻辑
            (async function runTests() {
                if (!window.paypal) {
                    // PayPal SDK failed to load
                    return;
                }

                try {
                    const results = await Promise.all(
                        countryList.map((item) => checkCountry(item)),
                    );

                    // Optionally handle results here
                    // For example, you could process the results array to see which countries worked
                } catch (err) {
                    // Handle test suite error
                }
            })();
        </script>
    </body>
</html>
